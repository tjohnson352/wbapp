{% extends "base.html" %}

{% block title %}Assign Activities to {{ current_day }}{% endblock %}

{% block header %}
<h1 class="page-header">The Schedulizer Web App</h1>
{% endblock %}

{% block content %}
<div class="upload-container">
    <h2>Assign Activities to {{ current_day }}</h2>
    <p class="description">
        Assign activities to <strong>{{ current_day }}</strong>. Use the checkboxes to select the activities you want to assign to this day, then click <strong>Save and Continue</strong>.
    </p>
    <h3>Add Frametime for {{ current_day }}</h3>
    <div class="frametime-input-container">
        <div class="frametime-group">
            <label for="isOff" class="frametime-label">OFF work day?</label>
            <select id="isOff" class="frametime-input">
                <option value="No" selected>No</option>
                <option value="Yes" style="background-color: red; color: white; font-weight: bold;">Yes</option>
            </select>
        </div>
        <div class="frametime-group">
            <label for="startTime" class="frametime-label">Start Time:</label>
            <input type="time" id="startTime" name="start_time" value="08:00" class="frametime-input">
        </div>
        <div class="frametime-group">
            <label for="endTime" class="frametime-label">End Time:</label>
            <input type="time" id="endTime" name="end_time" value="16:00" class="frametime-input">
        </div>
    </div>
    {% if table is not none %}
    <form id="scheduleForm" class="schedule-form">
        <!-- CSRF Token -->
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <table class="table">
            <thead>
                <tr>
                    <th>Select</th>
                    <th>Day</th>
                    <th>Timespan</th> <!-- Corrected label -->
                    <th>Activities</th>
                    <th>Type</th>
                    <th>Minutes</th> <!-- Corrected label -->
                </tr>
            </thead>
            <tbody>
                {% for _, row in table.iterrows() %}
                    {% set is_unassigned = (row['day'] == 'Unassigned') %}
                    <tr class="{% if row['day'] == 'Monday' %}day-monday
                               {% elif row['day'] == 'Tuesday' %}day-tuesday
                               {% elif row['day'] == 'Wednesday' %}day-wednesday
                               {% elif row['day'] == 'Thursday' %}day-thursday
                               {% elif row['day'] == 'Friday' %}day-friday
                               {% elif is_unassigned %}{% if loop.index is even %}bg-gray{% else %}bg-white{% endif %}{% endif %}">
                        <td>
                            {% if is_unassigned %}
                                <input type="checkbox" class="activity-checkbox" value="{{ loop.index0 }}">
                            {% else %}
                                <!-- Empty cell when not unassigned -->
                            {% endif %}
                        </td>
                        {% for col, value in row.items() %}
                            <td class="{% if value == 'undefined' %}undefined-value{% endif %}">{{ value }}</td>
                        {% endfor %}
                    </tr>
                {% endfor %}
            </tbody>            
        </table>
        <div class="button-container">
            <button type="button" class="btn btn-primary" id="saveBtn">Save & Continue</button>
        </div>
    </form>
    
    {% else %}
    <p>No data to display. Please upload a schedule first.</p>
    {% endif %}
</div>

<script>
document.getElementById('isOff').addEventListener('change', function () {
    const isOff = this.value === 'Yes';
    document.getElementById('startTime').disabled = isOff;
    document.getElementById('endTime').disabled = isOff;
});

document.getElementById('saveBtn').addEventListener('click', function () {
    const selectedActivities = Array.from(document.querySelectorAll('.activity-checkbox:checked')).map(cb => parseInt(cb.value));
    const isOff = document.getElementById('isOff').value.trim();
    const startTimeInput = document.getElementById('startTime');
    const endTimeInput = document.getElementById('endTime');

    let startTime = startTimeInput.value.trim();
    let endTime = endTimeInput.value.trim();

    if (isOff === 'Yes') {
        startTime = 'null';
        endTime = 'null';
    } else if (!startTime || !endTime || selectedActivities.length === 0) {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Please complete all required fields.',
            confirmButtonText: 'OK'
        });
        return;
    }

    const payload = {
        frametime: { start_time: startTime, end_time: endTime },
        selected_activities: isOff === 'Yes' ? [] : selectedActivities,
        is_off: isOff === 'Yes'
    };

    fetch('/days', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        },
        body: JSON.stringify(payload)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => {
                console.error('Server error:', err);
                throw new Error(err.error || 'Unexpected error occurred.');
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.complete) {
            Swal.fire({
                icon: 'success',
                title: 'Success',
                text: 'All days have been updated successfully!',
                confirmButtonText: 'OK'
            }).then(() => {
                window.location.href = '/schedule_summary';
            });
        } else {
            Swal.fire({
                icon: 'success',
                title: 'Success',
                text: data.message,
                confirmButtonText: 'OK'
            }).then(() => {
                window.location.reload();
            });
        }
    })
    .catch(error => {
        console.error('Error during fetch:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: error.message || 'An unexpected error occurred. Please try again.',
            confirmButtonText: 'OK'
        });
    });
});

</script>
<style>
    .bg-gray {
        background-color: #F0F0F0; /* Light gray */
    }

    .bg-white {
        background-color: #FFFFFF; /* White */
    }

    .frametime-input-container {
        display: flex;
        gap: 40px;
        justify-content: flex-start;
        margin-bottom: 20px;
    }

    .frametime-group {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
    }

    .frametime-label {
        font-weight: bold;
        margin-bottom: 5px;
    }

    .frametime-input {
        width: 140px;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 1rem;
    }

    .frametime-input:focus {
        border-color: #007bff;
        outline: none;
        box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
    }

    /* Dropdown menu styling */
    select option[value="Yes"] {
        background-color: red;
        color: white;
        font-weight: bold;
    }

    /* Table row colors for each day */
    .day-monday {
        background-color: #FFF8DC; /* Light yellow */
    }
    .day-tuesday {
        background-color: #E6F7FF; /* Light blue */
    }
    .day-wednesday {
        background-color: #F5F5F5; /* Light gray */
    }
    .day-thursday {
        background-color: #FFEBEE; /* Light pink */
    }
    .day-friday {
        background-color: #E8F5E9; /* Light green */
    }

    /* Default unassigned row color */
    .day-unassigned {
        background-color: #FFFFFF; /* Default white */
    }

    /* Highlight "undefined" values */
    .undefined-value {
        color: red;
        font-weight: bold;
    }
</style>
{% endblock %}
